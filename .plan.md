# 타임라인 사진 드래그 기능 구현 계획

## 목표
TimelineSection 내 사진을 드래그하여 위치를 조정하고, 저장된 위치가 새로고침 후에도 유지되도록 구현

## 핵심 요구사항
1. TimelineSection 내에서만 드래그 가능 (시간대 변경 X)
2. 드래그 완료 시 x, y 좌표를 Supabase에 저장
3. position: relative → position: absolute로 자동 전환
4. 기존 UI 규칙 유지 (사진 겹침 방지 등)

## 구현 단계

### 1. 타입 정의 추가 (types/index.ts)
- `PhotoPosition`: { photoId, timeBlockTime, x, y }
- PhotoItem 타입 유지 (x, y 추가 X → 별도 테이블로 관리)

### 2. Supabase 설정 (lib/supabase.ts)
- `PHOTO_POSITIONS_TABLE = 'photo_positions'` 상수 추가
- DB 테이블 생성 (Supabase Console 또는 migration):
  ```sql
  CREATE TABLE photo_positions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    photo_id UUID NOT NULL,
    time_block TEXT NOT NULL,
    x FLOAT NOT NULL,
    y FLOAT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(photo_id, time_block)
  );
  ```

### 3. API 엔드포인트 생성
#### POST /api/photos/positions/save
```json
{
  "photoId": "uuid",
  "timeBlockTime": "09:00",
  "x": 100,
  "y": 50
}
```
응답: { success: true, data: {...} }

#### GET /api/photos/positions/get?photoId=xxx&time=09:00
응답: { x, y } 또는 null

### 4. TimelineImage 컴포넌트 수정
**props 추가**:
- timeBlockTime: string (e.g., "09:00")
- onDragComplete?: (photoId, x, y) => Promise<void>

**상태 추가**:
- isDragging: boolean
- position: { x, y }
- dragOffset: { x, y } (드래그 중 오프셋)

**동작**:
- 로드 시: GET /api/photos/positions/get으로 저장된 위치 로드
- onDragStart: cursor: grabbing, z-index 상승
- onDrag: 드래그 위치 추적 (offsetX, offsetY)
- onDragEnd:
  - 범위 내면 위치 저장
  - 범위 밖이면 원위치 복구
  - POST /api/photos/positions/save 호출

**스타일**:
- 기본: position: relative, display: block (기존)
- 드래그 가능: position: absolute, cursor: grab
- 드래그 중: cursor: grabbing, z-index 높음

### 5. TimelineSection 컴포넌트 수정
**props 추가**:
- onPhotoPositionChange?: (photoId, x, y) => Promise<void>

**동작**:
- onDragOver: dragenter/dragover 이벤트 기본 동작 방지
- onDrop: 위치 유효성 검사
- Ref: TimelineSection의 getBoundingClientRect() 사용 → 범위 제한

### 6. CSS 업데이트 (globals.css)
- .timeline-image-draggable: cursor: grab
- .timeline-image-dragging: cursor: grabbing, z-index 증가
- .timeline-section-drop-zone: position 설정 (드래그 범위)

### 7. 상태 흐름
```
TimelineColumn (데이터 관리)
├── TimelineSection (드롭존 + 범위 제한)
│   └── TimelineImage (드래그 + 위치 저장)
│       ├── 로드: GET /api/photos/positions/get
│       ├── 드래그 중: 위치 추적
│       └── 완료: POST /api/photos/positions/save
```

## 파일 변경 목록
1. types/index.ts - PhotoPosition 타입 추가
2. lib/supabase.ts - PHOTO_POSITIONS_TABLE 상수 추가
3. app/api/photos/positions/save/route.ts - 새 파일
4. app/api/photos/positions/get/route.ts - 새 파일
5. components/timeline/TimelineImage.tsx - 드래그 로직 추가
6. components/timeline/TimelineSection.tsx - 드롭존 + 범위 제한
7. globals.css - 드래그 스타일 추가

## 주의사항
- 시간대 변경 기능은 구현하지 않음 (범위 내 드래그만)
- 기존 UI 규칙 (사진 겹침 방지, position: relative) 유지
- Supabase RLS 정책 확인 필요
- UUID 타입 사용 (crypto.randomUUID())
